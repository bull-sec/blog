# SMB - Port 139 & 445

SMB stands for Serial Message Bus, it's a protocol, it's used to store files. There have been a bucket load of vulnerabilities for various versions over the years, with probably the most high profile being `MS17-010` otherwise known as `EternalBlue` which was part of the files which were leaked from the NSA along with a bunch of their internal tooling.

OK, that's the admin done.

---

## Enumerating SMB

Enumerate the hostname: `nmblookup -A ip`

Look for null/anonymous sessions:

- `smbmap -H ip/hostname`
- `rpcclient -U "" -N ip`
- `smbclient \\\\ip\\share`

List available shares:

- `smbmap -H ip/hostname`
- `echo exit | smbclient -L \\\\ip`
- `nmap --script smb-enum-shares -p 139,445 ip`

Check for vulnerabilities:

- `nmap --script smb-vuln* -p 139,445 ip`

If you're having trouble getting the version you can often get it from `wireshark` or `tcpdump`, just send a request to the server and check out the TCP stream and it should have some additional information in there for you.

One of the guis on the PWK forums wrote the following to check for the version:

```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
sleep 0.5 && echo ""
```

## Known Vulnerabilities

## Bruteforcing

Saved this til last, and not because it's the best, but because it probably should be a last resort. Bruteforcing is just that, it's brute and it's based and we should always strive to be smarter not just more persistent. Although there is something to be said for an approach which favours the latter.


